import{p as Ae,r as d,a as W,b as Z,a0 as M,w as Ee,j as e,P as he,R as De,z as Le,u as ee,m as C,C as A,k as F,Z as ue,B as b,l as N,n as U,a1 as K,a2 as ge,g as fe,h as pe,a3 as H,G as ie,X as L,_ as $,s as je,a4 as X,$ as Ne,a5 as be,a6 as we,f as se,o as le,e as $e,H as ze,S as Te,M as Re,A as Ue,c as O,t as ne}from"./index-459497b8.js";import{T as He,a as Ge,b as ce,c as oe}from"./tabs-7b5ae36b.js";import{u as ve,G as Ve,H as Be}from"./useStripe-4a22a2bd.js";import{P as J}from"./plus-c6d946f8.js";import{T as de}from"./trash-2-848cc76c.js";const q=Ae("Bot",[["path",{d:"M12 8V4H8",key:"hb8ula"}],["rect",{width:"16",height:"12",x:"4",y:"8",rx:"2",key:"enze0r"}],["path",{d:"M2 14h2",key:"vft8re"}],["path",{d:"M20 14h2",key:"4cs60a"}],["path",{d:"M15 13v2",key:"1xurst"}],["path",{d:"M9 13v2",key:"rq6x2g"}]]),ye=()=>{const[s,i]=d.useState(null),[o,a]=d.useState(!0),{user:t,profile:l}=W(),{toast:n}=Z(),m=d.useCallback(async()=>{if(!t){i(null),a(!1);return}try{const{data:f,error:r}=await M.rpc("can_send_message",{user_uuid:t.id});if(r)throw r;i(f)}catch(f){console.error("Error fetching message limits:",f),i({can_send:!1,plan:"free",messages_used:5,messages_remaining:0,daily_limit:5,is_admin:!1})}finally{a(!1)}},[t]),p=d.useCallback(async()=>{if(!t||!s)return null;if(s.plan!=="free"||s.is_admin)return s;try{const{data:f,error:r}=await M.rpc("increment_daily_message_count",{user_uuid:t.id});if(r)throw r;const c={...s,messages_used:f,messages_remaining:Math.max(0,s.daily_limit-f),can_send:f<s.daily_limit};return i(c),f===s.daily_limit-1?n({title:"⚠️ Ultimo messaggio gratuito!",description:"Hai utilizzato 4 dei 5 messaggi giornalieri. Considera l'upgrade a Premium per messaggi illimitati."}):f>=s.daily_limit&&n({title:"🚫 Limite raggiunto!",description:"Hai utilizzato tutti i 5 messaggi gratuiti di oggi. Torna domani o passa a Premium!",variant:"destructive"}),c}catch(f){return console.error("Error incrementing message count:",f),s}},[t,s,n]),v=d.useCallback(()=>s?s.is_admin||s.plan==="premium"||s.plan==="trial"&&s.trial_ends_at&&new Date(s.trial_ends_at)>new Date?!0:s.can_send:!1,[s]),y=d.useCallback(()=>{const f=new Date,r=new Date(f);r.setDate(r.getDate()+1),r.setHours(0,0,0,0);const c=r.getTime()-f.getTime(),w=Math.floor(c/(1e3*60*60)),S=Math.floor(c%(1e3*60*60)/(1e3*60));return{hours:w,minutes:S}},[]);return d.useEffect(()=>{m()},[m]),d.useEffect(()=>{const f=setInterval(()=>{s&&!s.can_send&&s.plan==="free"&&m()},6e4);return()=>clearInterval(f)},[s,m]),{limits:s,loading:o,fetchLimits:m,incrementMessageCount:p,checkCanSendMessage:v,getTimeUntilReset:y,isLimitReached:s&&!s.can_send&&s.plan==="free",isPremium:s&&(s.plan==="premium"||s.is_admin||s.plan==="trial"&&s.trial_ends_at&&new Date(s.trial_ends_at)>new Date)}},Oe=()=>{const{toast:s}=Z(),i=d.useCallback((a,t=null)=>{console.error("Error occurred:",a);let l=t||"Si è verificato un errore imprevisto",n="Errore";return a.message&&(a.message.includes("Network")?(n="Errore di Connessione",l="Controlla la tua connessione internet e riprova"):a.message.includes("Authentication")?(n="Errore di Autenticazione",l="Sessione scaduta. Effettua nuovamente l'accesso"):a.message.includes("Permission")?(n="Accesso Negato",l="Non hai i permessi per eseguire questa azione"):l=a.message),s({title:n,description:l,variant:"destructive"}),{type:n,message:l,original:a}},[s]),o=d.useCallback(a=>async(...t)=>{try{return await a(...t)}catch(l){throw i(l),l}},[i]);return{handleError:i,handleAsyncError:o}},qe=()=>{const[s,i]=d.useState([]),[o,a]=d.useState(null),[t,l]=d.useState([]),[n,m]=d.useState(!1),[p,v]=d.useState(null),{user:y,profile:f}=W(),{toast:r}=Z(),{handleError:c}=Oe(),{limits:w,incrementMessageCount:S,checkCanSendMessage:j,fetchLimits:G,isLimitReached:Q}=ye(),z=d.useCallback(async()=>{if(y)try{const{data:u,error:g}=await M.rpc("get_user_plan_status");if(g)throw g;v(u[0])}catch(u){console.error("Error fetching plan status:",u)}},[y]),P=d.useCallback(async()=>{if(y)try{const{data:u,error:g}=await M.from("chat_sessions").select("*").order("updated_at",{ascending:!1});if(g)throw g;i(u||[])}catch(u){c(u,"Impossibile caricare le sessioni di chat.")}},[y,r]),T=d.useCallback(async u=>{if(u)try{const{data:g,error:_}=await M.from("chat_messages").select("*").eq("session_id",u).order("created_at",{ascending:!0});if(_)throw _;l(g||[])}catch(g){c(g,"Impossibile caricare i messaggi.")}},[r]),V=d.useCallback(async(u,g="free",_=null)=>{var I,R;if(!u.trim())return null;if(g==="free"&&!j())return r({title:"🚫 Limite messaggi raggiunto!",description:"Hai utilizzato tutti i 5 messaggi gratuiti di oggi. Torna domani o passa a Premium!",variant:"destructive"}),{success:!1,error:"DAILY_LIMIT_REACHED"};m(!0);try{g==="free"&&w&&w.plan==="free"&&await S();const{data:x,error:D}=await M.functions.invoke("chat-openai",{body:{message:u.trim(),sessionId:_,chatType:g}});if(D)throw D;return!_&&x.sessionId&&(a(x.sessionId),await P()),x.sessionId&&await T(x.sessionId),x.planStatus&&v(x.planStatus),g==="free"&&await G(),{success:!0,sessionId:x.sessionId,message:x.message,tokensUsed:x.tokensUsed}}catch(x){return console.error("Error sending message:",x),(I=x.message)!=null&&I.includes("Premium access required")?(r({title:"Accesso Premium Richiesto",description:"Aggiorna il tuo piano per accedere alla chat premium.",variant:"destructive"}),{success:!1,error:"PREMIUM_REQUIRED"}):(R=x.message)!=null&&R.includes("DAILY_LIMIT_REACHED")?{success:!1,error:"DAILY_LIMIT_REACHED"}:(r({title:"Errore nell'invio del messaggio",description:x.message||"Si è verificato un errore imprevisto.",variant:"destructive"}),{success:!1,error:x.message})}finally{m(!1)}},[r,P,T,j,S,w,G]),B=d.useCallback(async(u="Nuova Chat",g="free")=>{try{const{data:_,error:I}=await M.rpc("create_chat_session",{session_title:u,session_type:g});if(I)throw I;return a(_),await P(),l([]),_}catch(_){return console.error("Error creating session:",_),r({title:"Errore",description:_.message||"Impossibile creare una nuova sessione di chat.",variant:"destructive"}),null}},[P,r]),re=d.useCallback(async u=>{try{const{error:g}=await M.from("chat_sessions").delete().eq("id",u);if(g)throw g;o===u&&(a(null),l([])),await P(),r({title:"Sessione eliminata",description:"La sessione di chat è stata eliminata con successo."})}catch(g){console.error("Error deleting session:",g),r({title:"Errore",description:"Impossibile eliminare la sessione di chat.",variant:"destructive"})}},[o,P,r]),E=d.useCallback(async u=>{a(u),await T(u)},[T]);return d.useEffect(()=>{y&&(z(),P())},[y,z,P]),{sessions:s,currentSession:o,messages:t,loading:n,planStatus:p,limits:w,isLimitReached:Q,sendMessage:V,createSession:B,deleteSession:re,selectSession:E,fetchPlanStatus:z,fetchSessions:P,checkCanSendMessage:j}};var ae="Progress",te=100,[Fe,os]=Ee(ae),[Xe,Ye]=Fe(ae),_e=d.forwardRef((s,i)=>{const{__scopeProgress:o,value:a=null,max:t,getValueLabel:l=Ze,...n}=s;(t||t===0)&&!me(t)&&console.error(Qe(`${t}`,"Progress"));const m=me(t)?t:te;a!==null&&!xe(a,m)&&console.error(Je(`${a}`,"Progress"));const p=xe(a,m)?a:null,v=Y(p)?l(p,m):void 0;return e.jsx(Xe,{scope:o,value:p,max:m,children:e.jsx(he.div,{"aria-valuemax":m,"aria-valuemin":0,"aria-valuenow":Y(p)?p:void 0,"aria-valuetext":v,role:"progressbar","data-state":Pe(p,m),"data-value":p??void 0,"data-max":m,...n,ref:i})})});_e.displayName=ae;var Ce="ProgressIndicator",Se=d.forwardRef((s,i)=>{const{__scopeProgress:o,...a}=s,t=Ye(Ce,o);return e.jsx(he.div,{"data-state":Pe(t.value,t.max),"data-value":t.value??void 0,"data-max":t.max,...a,ref:i})});Se.displayName=Ce;function Ze(s,i){return`${Math.round(s/i*100)}%`}function Pe(s,i){return s==null?"indeterminate":s===i?"complete":"loading"}function Y(s){return typeof s=="number"}function me(s){return Y(s)&&!isNaN(s)&&s>0}function xe(s,i){return Y(s)&&!isNaN(s)&&s<=i&&s>=0}function Qe(s,i){return`Invalid prop \`max\` of value \`${s}\` supplied to \`${i}\`. Only numbers greater than 0 are valid max values. Defaulting to \`${te}\`.`}function Je(s,i){return`Invalid prop \`value\` of value \`${s}\` supplied to \`${i}\`. The \`value\` prop must be:
  - a positive number
  - less than the value passed to \`max\` (or ${te} if no \`max\` prop is set)
  - \`null\` or \`undefined\` if the progress is indeterminate.

Defaulting to \`null\`.`}var Ie=_e,Ke=Se;const ke=De.forwardRef(({className:s,value:i,...o},a)=>e.jsx(Ie,{ref:a,className:Le("relative h-4 w-full overflow-hidden rounded-full bg-secondary",s),...o,children:e.jsx(Ke,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(i||0)}%)`}})}));ke.displayName=Ie.displayName;function We({limits:s,timeUntilReset:i}){const o=ee();if(!s||s.is_admin||s.plan==="premium")return null;if(s.plan==="trial"&&s.trial_ends_at){const n=new Date(s.trial_ends_at),p=Math.ceil((n-new Date)/(1e3*60*60*24));if(p>0)return e.jsx(C.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"p-4",children:e.jsx(A,{className:"bg-gradient-to-r from-blue-900/20 to-purple-900/20 border border-blue-500/30",children:e.jsx(F,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center",children:e.jsx(ue,{className:"w-4 h-4 text-white"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-blue-300 font-semibold text-sm",children:"Prova Gratuita Attiva"}),e.jsxs("p",{className:"text-blue-200 text-xs",children:[p," giorni rimasti • Messaggi illimitati"]})]})]}),e.jsxs(b,{size:"sm",onClick:()=>o("/subscription"),className:"sardinian-gradient hover:opacity-90",children:[e.jsx(N,{className:"w-3 h-3 mr-1"}),"Upgrade"]})]})})})})}const a=s.messages_used/s.daily_limit*100,t=s.messages_used>=s.daily_limit-1,l=!s.can_send;return e.jsx(C.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"p-4",children:e.jsx(A,{className:`${l?"bg-gradient-to-r from-red-900/20 to-orange-900/20 border border-red-500/30":t?"bg-gradient-to-r from-yellow-900/20 to-orange-900/20 border border-yellow-500/30":"bg-gradient-to-r from-slate-900/20 to-slate-800/20 border border-slate-600"}`,children:e.jsx(F,{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(U,{className:`w-4 h-4 ${l?"text-red-400":t?"text-yellow-400":"text-blue-400"}`}),e.jsx("span",{className:`font-semibold text-sm ${l?"text-red-300":t?"text-yellow-300":"text-blue-300"}`,children:"Messaggi Giornalieri"})]}),l&&e.jsxs(b,{size:"sm",onClick:()=>o("/subscription"),className:"sardinian-gradient hover:opacity-90",children:[e.jsx(N,{className:"w-3 h-3 mr-1"}),"Upgrade"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsxs("span",{className:l?"text-red-300":"text-gray-300",children:[s.messages_used," / ",s.daily_limit," utilizzati"]}),e.jsxs("span",{className:l?"text-red-300":"text-gray-300",children:[s.messages_remaining," rimasti"]})]}),e.jsx(ke,{value:a,className:`h-2 ${l?"bg-red-900/30":t?"bg-yellow-900/30":"bg-slate-700"}`})]}),l?e.jsxs("div",{className:"flex items-center space-x-2 text-red-300 text-xs",children:[e.jsx(K,{className:"w-3 h-3"}),e.jsxs("span",{children:["Limite raggiunto! Reset tra ",i.hours,"h ",i.minutes,"m"]})]}):t?e.jsxs("div",{className:"flex items-center space-x-2 text-yellow-300 text-xs",children:[e.jsx(K,{className:"w-3 h-3"}),e.jsxs("span",{children:["Attenzione: solo ",s.messages_remaining," messaggio/i rimasto/i oggi"]})]}):e.jsxs("div",{className:"flex items-center space-x-2 text-gray-400 text-xs",children:[e.jsx(ge,{className:"w-3 h-3"}),e.jsxs("span",{children:["Reset tra ",i.hours,"h ",i.minutes,"m"]})]}),(l||t)&&e.jsxs("div",{className:"pt-2 border-t border-slate-600",children:[e.jsx("p",{className:"text-xs text-gray-400 text-center mb-2",children:"Passa a Premium per messaggi illimitati"}),e.jsxs("div",{className:"flex items-center justify-center space-x-1 text-xs",children:[e.jsx(N,{className:"w-3 h-3 text-yellow-400"}),e.jsx("span",{className:"text-yellow-400",children:"€5/mese"}),e.jsx("span",{className:"text-gray-400",children:"•"}),e.jsx("span",{className:"text-gray-400",children:"Chat sarda autentica"})]})]})]})})})})}function es({limits:s,timeUntilReset:i}){const o=ee();return!s||s.can_send?null:e.jsx(C.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5},className:"flex-1 flex items-center justify-center p-8",children:e.jsxs(A,{className:"sardinian-card max-w-md w-full text-center",children:[e.jsxs(fe,{children:[e.jsx(C.div,{initial:{scale:0},animate:{scale:1},transition:{delay:.2,type:"spring",stiffness:200},className:"w-16 h-16 bg-orange-600 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(K,{className:"w-8 h-8 text-white"})}),e.jsx(pe,{className:"text-2xl text-white mb-2",children:"Limite Messaggi Raggiunto! 📝"}),e.jsxs("p",{className:"text-gray-300",children:["Hai utilizzato tutti i ",e.jsxs("strong",{children:[s.daily_limit," messaggi gratuiti"]})," di oggi"]})]}),e.jsxs(F,{className:"space-y-6",children:[e.jsxs("div",{className:"bg-slate-800/30 p-4 rounded-lg border border-slate-600",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2 mb-2",children:[e.jsx(ge,{className:"w-4 h-4 text-blue-400"}),e.jsx("span",{className:"text-blue-300 font-semibold",children:"Reset Automatico"})]}),e.jsxs("p",{className:"text-white text-lg font-bold",children:[i.hours,"h ",i.minutes,"m"]}),e.jsx("p",{className:"text-gray-400 text-sm",children:"I tuoi messaggi si resettano a mezzanotte"})]}),e.jsxs("div",{className:"bg-gradient-to-r from-yellow-900/20 to-orange-900/20 p-4 rounded-lg border border-yellow-500/20",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2 mb-3",children:[e.jsx(N,{className:"w-5 h-5 text-yellow-400"}),e.jsx("span",{className:"text-yellow-300 font-semibold",children:"SardAI Premium"})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(H,{className:"w-4 h-4 text-yellow-400"}),e.jsx("span",{className:"text-yellow-200",children:"Messaggi illimitati"})]}),e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(U,{className:"w-4 h-4 text-yellow-400"}),e.jsx("span",{className:"text-yellow-200",children:"Chat in lingua sarda autentica"})]}),e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(ie,{className:"w-4 h-4 text-yellow-400"}),e.jsx("span",{className:"text-yellow-200",children:"Contenuti culturali esclusivi"})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(b,{onClick:()=>o("/subscription"),className:"w-full sardinian-gradient hover:opacity-90 text-lg py-3",children:[e.jsx(N,{className:"w-5 h-5 mr-2"}),"Diventa Premium - €5/mese"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx(b,{onClick:()=>o("/dashboard"),variant:"outline",className:"border-white/20 text-white hover:bg-white/10",children:"Dashboard"}),e.jsxs(b,{onClick:()=>o("/subscription"),variant:"outline",className:"border-yellow-400/50 text-yellow-400 hover:bg-yellow-400/10",children:[e.jsx(ie,{className:"w-4 h-4 mr-1"}),"Piano Annuale"]})]})]}),e.jsx("div",{className:"pt-4 border-t border-slate-600",children:e.jsx("p",{className:"text-gray-400 text-sm italic",children:'"Aho, per oggi hai chiacchierato abbastanza! Torna domani o diventa Premium!" 😄'})})]})]})})}function ss({messages:s,onSendMessage:i,loading:o,planStatus:a,limits:t,isLimitReached:l}){const[n,m]=d.useState(""),p=d.useRef(null),{getTimeUntilReset:v}=ye(),y=()=>{var c;(c=p.current)==null||c.scrollIntoView({behavior:"smooth"})};d.useEffect(()=>{y()},[s]);const f=async c=>{c.preventDefault();const w=we(n);if(!w.isValid||o||l)return;const S=await i(w.sanitizedMessage,"free");S!=null&&S.success&&m("")},r=c=>c.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br>");return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{className:"p-4 border-b border-slate-600 bg-slate-800/30",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(L,{className:"w-10 h-10",children:e.jsx($,{className:"bg-blue-600 text-white",children:e.jsx(q,{className:"w-5 h-5"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-white font-semibold",children:"SardAI Gratuito"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"Assistente con carattere sardo"})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto space-y-4",children:[t&&t.plan==="free"&&e.jsx(We,{limits:t,timeUntilReset:v()}),l?e.jsx(es,{limits:t,timeUntilReset:v()}):e.jsxs("div",{className:"p-4 space-y-4",children:[s.length===0&&e.jsxs(C.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"text-center py-8",children:[e.jsx(q,{className:"w-16 h-16 text-blue-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"Ciao! Sono SardAI! 👋"}),e.jsx("p",{className:"text-gray-300 max-w-md mx-auto",children:"Sono qui per aiutarti con tutto quello che vuoi sapere sulla Sardegna. Dimmi, cosa ti va di scoprire della nostra bella isola?"})]}),s.map((c,w)=>e.jsx(C.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:w*.1},className:`flex ${c.role==="user"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`flex items-start space-x-3 max-w-xs lg:max-w-md xl:max-w-lg ${c.role==="user"?"flex-row-reverse space-x-reverse":""}`,children:[e.jsx(L,{className:"w-8 h-8 flex-shrink-0",children:e.jsx($,{className:c.role==="user"?"bg-green-600":"bg-blue-600",children:c.role==="user"?e.jsx(je,{className:"w-4 h-4"}):e.jsx(q,{className:"w-4 h-4"})})}),e.jsxs(A,{className:`px-4 py-3 ${c.role==="user"?"chat-bubble-user text-white border-0":"chat-bubble-ai text-white border-0"}`,children:[e.jsx("div",{className:"text-sm leading-relaxed",dangerouslySetInnerHTML:{__html:r(c.content)}}),e.jsx("p",{className:"text-xs opacity-70 mt-2",children:new Date(c.created_at).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})})]})]})},w)),o&&e.jsx(C.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex justify-start",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(L,{className:"w-8 h-8",children:e.jsx($,{className:"bg-blue-600",children:e.jsx(q,{className:"w-4 h-4"})})}),e.jsx(A,{className:"chat-bubble-ai text-white border-0 px-4 py-3",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(X,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{className:"text-sm",children:"SardAI sta pensando..."})]})})]})}),e.jsx("div",{ref:p})]})]}),!l&&e.jsxs("div",{className:"p-4 border-t border-slate-600 bg-slate-800/30",children:[e.jsxs("form",{onSubmit:f,className:"flex space-x-2",children:[e.jsx(Ne,{value:n,onChange:c=>m(c.target.value),placeholder:t&&t.plan==="free"?`Scrivi il tuo messaggio... (${t.messages_remaining} rimasti oggi)`:"Scrivi il tuo messaggio...",disabled:o||l,className:"bg-slate-800/50 border-slate-600 text-white placeholder:text-gray-400"}),e.jsx(b,{type:"submit",disabled:!n.trim()||o||l,className:"sardinian-gradient hover:opacity-90",children:o?e.jsx(X,{className:"w-4 h-4 animate-spin"}):e.jsx(be,{className:"w-4 h-4"})})]}),a&&e.jsxs("div",{className:"mt-2 text-xs text-gray-400 text-center",children:[a.plan==="trial"&&a.trial_days_left>0&&e.jsxs("span",{children:["Prova gratuita: ",a.trial_days_left," giorni rimasti"]}),a.plan==="free"&&e.jsx("span",{children:"Piano gratuito - Aggiorna per accedere alla modalità sarda"})]})]})]})}function as({messages:s,onSendMessage:i,loading:o,isAdmin:a=!1}){const[t,l]=d.useState(""),n=d.useRef(null),{subscription:m}=se(),p=()=>{var r;(r=n.current)==null||r.scrollIntoView({behavior:"smooth"})};d.useEffect(()=>{p()},[s]);const v=async r=>{r.preventDefault();const c=we(t);if(!c.isValid||o)return;const w=await i(c.sanitizedMessage,"premium");w!=null&&w.success&&l("")},y=r=>r.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br>");return(m==null?void 0:m.isActive)||!1?e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{className:"p-4 border-b border-slate-600 bg-gradient-to-r from-yellow-900/30 to-orange-900/30",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(L,{className:"w-10 h-10",children:e.jsx($,{className:"bg-yellow-600 text-white",children:e.jsx(N,{className:"w-5 h-5"})})}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-white font-semibold flex items-center",children:[e.jsx(N,{className:"w-4 h-4 mr-2 text-yellow-400"}),"SardAI Premium"]}),e.jsx("p",{className:"text-gray-400 text-sm",children:"Chat in lingua sarda autentica"})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[s.length===0&&e.jsxs(C.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"text-center py-8",children:[e.jsx(N,{className:"w-16 h-16 text-yellow-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"Salude! Deo so SardAI Premium! 👑"}),e.jsx("p",{className:"text-gray-300 max-w-md mx-auto",children:"Oe, comente ses? Deo so inoghe pro ti agiudare in limba sarda auténtica. Ite boles ischire de sa Sardigna nostra?"})]}),s.map((r,c)=>e.jsx(C.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:c*.1},className:`flex ${r.role==="user"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`flex items-start space-x-3 max-w-xs lg:max-w-md xl:max-w-lg ${r.role==="user"?"flex-row-reverse space-x-reverse":""}`,children:[e.jsx(L,{className:"w-8 h-8 flex-shrink-0",children:e.jsx($,{className:r.role==="user"?"bg-green-600":"bg-yellow-600",children:r.role==="user"?e.jsx(je,{className:"w-4 h-4"}):a?e.jsx(Shield,{className:"w-4 h-4"}):e.jsx(N,{className:"w-4 h-4"})})}),e.jsxs(A,{className:`px-4 py-3 ${r.role==="user"?"chat-bubble-user text-white border-0":a?"bg-gradient-to-r from-red-900/20 to-red-800/20 text-white border border-red-500/20":"bg-gradient-to-r from-yellow-900/20 to-orange-900/20 text-white border border-yellow-500/20"}`,children:[e.jsx("div",{className:"text-sm leading-relaxed",dangerouslySetInnerHTML:{__html:y(r.content)}}),e.jsx("p",{className:"text-xs opacity-70 mt-2",children:new Date(r.created_at).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})})]})]})},c)),o&&e.jsx(C.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex justify-start",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(L,{className:"w-8 h-8",children:e.jsx($,{className:a?"bg-red-600":"bg-yellow-600",children:a?e.jsx(Shield,{className:"w-4 h-4"}):e.jsx(N,{className:"w-4 h-4"})})}),e.jsx(A,{className:`px-4 py-3 text-white border ${a?"bg-gradient-to-r from-red-900/20 to-red-800/20 border-red-500/20":"bg-gradient-to-r from-yellow-900/20 to-orange-900/20 border-yellow-500/20"}`,children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(X,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{className:"text-sm",children:a?"SardAI Admin sta elaborando...":"SardAI est pensende..."})]})})]})}),e.jsx("div",{ref:n})]}),e.jsxs("div",{className:`p-4 border-t border-slate-600 ${a?"bg-gradient-to-r from-red-900/10 to-red-800/10":"bg-gradient-to-r from-yellow-900/10 to-orange-900/10"}`,children:[e.jsxs("form",{onSubmit:v,className:"flex space-x-2",children:[e.jsx(Ne,{value:t,onChange:r=>l(r.target.value),placeholder:a?"Scrivi il tuo messaggio...":"Iscrie su messàgiu tuo in sardu...",disabled:o,className:`bg-slate-800/50 text-white placeholder:text-gray-400 ${a?"border-red-500/30 focus:border-red-400":"border-yellow-500/30 focus:border-yellow-400"}`}),e.jsx(b,{type:"submit",disabled:!t.trim()||o,className:a?"bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800":"bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-700 hover:to-orange-700",children:o?e.jsx(X,{className:"w-4 h-4 animate-spin"}):e.jsx(be,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"mt-2 text-xs text-yellow-400 text-center",children:[a?e.jsx(Shield,{className:"w-3 h-3 inline mr-1"}):e.jsx(N,{className:"w-3 h-3 inline mr-1"}),a?"Modalità Admin Attiva - Accesso completo alle funzionalità":"Modalità Premium Attiva - Chat in lingua sarda autentica"]})]})]}):e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{className:"p-4 border-b border-slate-600 bg-gradient-to-r from-yellow-900/30 to-orange-900/30",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(L,{className:"w-10 h-10",children:e.jsx($,{className:a?"bg-red-600 text-white":"bg-yellow-600 text-white",children:a?e.jsx(Shield,{className:"w-5 h-5"}):e.jsx(N,{className:"w-5 h-5"})})}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-white font-semibold flex items-center",children:[a?e.jsx(Shield,{className:"w-4 h-4 mr-2 text-red-400"}):e.jsx(N,{className:"w-4 h-4 mr-2 text-yellow-400"}),a?"Benvenuto Admin! Accesso completo attivo 🛡️":"Salude! Deo so SardAI Premium! 👑"]}),e.jsx("p",{className:"text-gray-400 text-sm",children:a?"Come amministratore hai accesso a tutte le funzionalità avanzate di SardAI.":"Oe, comente ses? Deo so inoghe pro ti agiudare in limba sarda auténtica. Ite boles ischire de sa Sardigna nostra?"})]})]})}),e.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:e.jsxs(C.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"text-center max-w-md",children:[e.jsx("div",{className:"w-20 h-20 bg-yellow-600 rounded-full flex items-center justify-center mx-auto mb-6",children:e.jsx(N,{className:"w-10 h-10 text-white"})}),e.jsx("h3",{className:"text-2xl font-bold text-white mb-4",children:"Accesso Premium Richiesto"}),e.jsx("p",{className:"text-gray-300 mb-6",children:"Per conversare in lingua sarda autentica con SardAI, devi avere un abbonamento Premium attivo."}),e.jsxs("div",{className:"space-y-3 text-sm text-gray-400 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(H,{className:"w-4 h-4 text-yellow-400"}),e.jsx("span",{children:"Chat in logudorese e campidanese"})]}),e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(H,{className:"w-4 h-4 text-yellow-400"}),e.jsx("span",{children:"Traduzione italiano/sardo"})]}),e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(H,{className:"w-4 h-4 text-yellow-400"}),e.jsx("span",{children:"Contenuti culturali esclusivi"})]})]}),e.jsxs(b,{onClick:()=>window.location.href="/subscription",className:"sardinian-gradient hover:opacity-90 px-8 py-3",children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),"Diventa Premium"]})]})})]})}function ts({className:s=""}){const{loading:i,createCheckoutSession:o}=ve(),{subscription:a}=se(),t=m=>{o(m,"subscription")};if(a!=null&&a.isActive)return null;const l=le.find(m=>m.interval==="month"),n=le.find(m=>m.interval==="year");return e.jsxs(A,{className:`sardinian-card premium-glow ${s}`,children:[e.jsxs(fe,{className:"text-center pb-4",children:[e.jsx("div",{className:"w-16 h-16 bg-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(N,{className:"w-8 h-8 text-white"})}),e.jsx(pe,{className:"text-white text-xl",children:"Sblocca SardAI Premium"})]}),e.jsxs(F,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-white font-semibold text-center mb-3",children:"Cosa ottieni con Premium:"}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"flex items-center space-x-3 text-sm",children:[e.jsx(Ve,{className:"w-4 h-4 text-yellow-400 flex-shrink-0"}),e.jsx("span",{className:"text-gray-300",children:"Chat in lingua sarda autentica"})]}),e.jsxs("div",{className:"flex items-center space-x-3 text-sm",children:[e.jsx(H,{className:"w-4 h-4 text-yellow-400 flex-shrink-0"}),e.jsx("span",{className:"text-gray-300",children:"Dialetti logudorese e campidanese"})]}),e.jsxs("div",{className:"flex items-center space-x-3 text-sm",children:[e.jsx(Be,{className:"w-4 h-4 text-yellow-400 flex-shrink-0"}),e.jsx("span",{className:"text-gray-300",children:"Contenuti culturali esclusivi"})]}),e.jsxs("div",{className:"flex items-center space-x-3 text-sm",children:[e.jsx(ue,{className:"w-4 h-4 text-yellow-400 flex-shrink-0"}),e.jsx("span",{className:"text-gray-300",children:"Traduzione italiano/sardo"})]})]})]}),e.jsxs("div",{className:"text-center pt-4 space-y-3",children:[l&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2 mb-2",children:[e.jsxs("span",{className:"text-2xl font-bold text-white",children:[l.price," ",l.currency]}),e.jsx("span",{className:"text-gray-400 text-sm",children:"/mese"})]}),e.jsx(b,{onClick:()=>t(l.priceId),disabled:i,className:"w-full sardinian-gradient hover:opacity-90 text-lg py-3",children:i?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),e.jsx("span",{children:"Caricamento..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"w-5 h-5 mr-2"}),"Diventa Premium"]})})]}),n&&e.jsxs("div",{className:"border-t border-slate-600 pt-3",children:[e.jsxs("div",{className:"flex items-center justify-center space-x-2 mb-2",children:[e.jsxs("span",{className:"text-lg font-bold text-white",children:[n.price," ",n.currency]}),e.jsx("span",{className:"text-gray-400 text-sm",children:"/anno"}),e.jsx("span",{className:"text-green-400 text-xs bg-green-900/30 px-2 py-1 rounded",children:"Risparmia 17%"})]}),e.jsx(b,{onClick:()=>t(n.priceId),disabled:i,variant:"outline",className:"w-full border-yellow-500/50 text-yellow-400 hover:bg-yellow-500/10",children:"Piano Annuale"})]}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:"Cancella in qualsiasi momento"})]})]})]})}function ds(){const s=ee(),[i]=$e(),{user:o,profile:a}=W();Z();const{handlePaymentSuccess:t,handlePaymentCanceled:l}=ve(),{subscription:n,refetch:m}=se(),[p,v]=d.useState("free"),[y,f]=d.useState(!1),{sessions:r,currentSession:c,messages:w,loading:S,planStatus:j,limits:G,isLimitReached:Q,sendMessage:z,createSession:P,deleteSession:T,selectSession:V,fetchPlanStatus:B,checkCanSendMessage:re}=qe();d.useEffect(()=>{const h=i.get("payment");h==="success"?(t(),B(),m(),s("/chat",{replace:!0})):h==="canceled"&&(l(),s("/chat",{replace:!0}))},[i,t,l,s,B,m]);const E=async(h="free")=>{const k=await P(`Chat ${h}`,h);k&&(V(k),v(h))},u=async h=>{await T(h)},g=async h=>{await V(h);const k=r.find(Me=>Me.id===h);k&&v(k.chat_type)},_=w.filter(h=>c&&h.session_id===c),I=r.filter(h=>h.chat_type==="free"),R=r.filter(h=>h.chat_type==="premium"),x=(a==null?void 0:a.role)==="admin",D=(n==null?void 0:n.isActive)||x||(j==null?void 0:j.can_use_premium);return e.jsxs(e.Fragment,{children:[e.jsxs(ze,{children:[e.jsx("title",{children:"Chat - SardAI"}),e.jsx("meta",{name:"description",content:"Conversa con SardAI in modalità gratuita o premium con lingua sarda autentica."})]}),e.jsxs("div",{className:"min-h-screen sardinian-pattern flex",children:[e.jsx(Te,{isOpen:y,onClose:()=>f(!1)}),e.jsxs("div",{className:"flex-1 flex flex-col lg:flex-row",children:[e.jsxs("div",{className:"w-full lg:w-80 border-b lg:border-b-0 lg:border-r border-white/10 bg-slate-900/50",children:[e.jsxs("div",{className:"p-4 border-b border-white/10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx(b,{variant:"ghost",size:"icon",onClick:()=>f(!0),className:"lg:hidden text-white hover:bg-white/10",children:e.jsx(Re,{className:"w-5 h-5"})}),e.jsx("h2",{className:"text-lg font-semibold text-white",children:"Le tue Chat"}),e.jsx(b,{variant:"ghost",onClick:()=>s("/dashboard"),className:"text-white hover:bg-white/10",children:e.jsx(Ue,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(b,{onClick:()=>E("free"),variant:"outline",className:"w-full justify-start border-blue-500/50 text-blue-400 hover:bg-blue-500/10",children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Nuova Chat Gratuita"]}),D&&e.jsxs(b,{onClick:()=>E("premium"),variant:"outline",className:"w-full justify-start border-yellow-500/50 text-yellow-400 hover:bg-yellow-500/10",children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),x?e.jsx(O,{className:"w-4 h-4 mr-1"}):e.jsx(N,{className:"w-4 h-4 mr-1"}),"Nuova Chat ",x?"Admin":"Premium"]})]})]}),e.jsx("div",{className:"p-4 border-b border-white/10",children:e.jsxs("div",{className:"bg-slate-800/50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-300",children:"Stato Account"}),e.jsx("span",{className:`text-sm font-semibold ${x?"text-red-400":n!=null&&n.isActive||j!=null&&j.can_use_premium?"text-yellow-400":"text-blue-400"}`,children:x?"Admin":n!=null&&n.isActive?"Premium":(j==null?void 0:j.plan)==="trial"&&!(j!=null&&j.trial_expired)?"Prova Gratuita":"Gratuito"})]}),j&&e.jsxs("div",{className:"text-xs text-gray-400",children:[j.plan==="trial"&&!j.trial_expired&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ne,{className:"w-3 h-3"}),e.jsxs("span",{children:["Prova: ",j.trial_days_left," giorni rimasti"]})]}),(n==null?void 0:n.isActive)&&n.current_period_end&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ne,{className:"w-3 h-3"}),e.jsxs("span",{children:["Rinnovo: ",new Date(n.current_period_end*1e3).toLocaleDateString("it-IT")]})]})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[I.length>0&&e.jsxs("div",{className:"p-4",children:[e.jsxs("h3",{className:"text-sm font-medium text-gray-400 mb-3 flex items-center",children:[e.jsx(U,{className:"w-4 h-4 mr-2"}),"Chat Gratuite (",I.length,")"]}),e.jsx("div",{className:"space-y-2",children:I.map(h=>e.jsxs("div",{className:`group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-colors ${c===h.id?"bg-blue-600/20 border border-blue-500/30":"hover:bg-slate-800/50"}`,onClick:()=>g(h.id),children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-white truncate",children:h.title}),e.jsx("p",{className:"text-xs text-gray-400",children:new Date(h.updated_at).toLocaleDateString("it-IT")})]}),e.jsx(b,{variant:"ghost",size:"sm",onClick:k=>{k.stopPropagation(),u(h.id)},className:"opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 hover:bg-red-400/10",children:e.jsx(de,{className:"w-4 h-4"})})]},h.id))})]}),R.length>0&&e.jsxs("div",{className:"p-4",children:[e.jsxs("h3",{className:"text-sm font-medium text-gray-400 mb-3 flex items-center",children:[x?e.jsx(O,{className:"w-4 h-4 mr-2 text-red-400"}):e.jsx(N,{className:"w-4 h-4 mr-2 text-yellow-400"}),"Chat ",x?"Admin":"Premium"," (",R.length,")"]}),e.jsx("div",{className:"space-y-2",children:R.map(h=>e.jsxs("div",{className:`group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-colors ${c===h.id?x?"bg-red-600/20 border border-red-500/30":"bg-yellow-600/20 border border-yellow-500/30":"hover:bg-slate-800/50"}`,onClick:()=>g(h.id),children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-white truncate",children:h.title}),e.jsx("p",{className:"text-xs text-gray-400",children:new Date(h.updated_at).toLocaleDateString("it-IT")})]}),e.jsx(b,{variant:"ghost",size:"sm",onClick:k=>{k.stopPropagation(),u(h.id)},className:"opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 hover:bg-red-400/10",children:e.jsx(de,{className:"w-4 h-4"})})]},h.id))})]}),r.length===0&&e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(U,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400 mb-4",children:"Nessuna chat ancora"}),e.jsxs(b,{onClick:()=>E("free"),className:"sardinian-gradient hover:opacity-90",children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Inizia la prima chat"]})]}),!D&&e.jsx("div",{className:"p-4",children:e.jsx(ts,{})})]})]}),e.jsx("div",{className:"flex-1 flex flex-col",children:c?e.jsxs(He,{value:p,onValueChange:v,className:"flex-1 flex flex-col",children:[e.jsx("div",{className:"px-4 pt-4 border-b border-white/10",children:e.jsxs(Ge,{className:"bg-slate-800/50 border border-slate-600",children:[e.jsxs(ce,{value:"free",className:"flex items-center space-x-2",children:[e.jsx(U,{className:"w-4 h-4"}),e.jsx("span",{children:"Modalità Gratuita"})]}),e.jsxs(ce,{value:"premium",className:"flex items-center space-x-2",children:[x?e.jsx(O,{className:"w-4 h-4"}):e.jsx(N,{className:"w-4 h-4"}),e.jsxs("span",{children:["Modalità ",x?"Admin":"Premium"]}),!D&&e.jsx("span",{className:"ml-1 px-2 py-1 text-xs bg-yellow-500 text-black rounded-full",children:"Upgrade"})]})]})}),e.jsx(oe,{value:"free",className:"flex-1 flex flex-col mt-0",children:e.jsx(ss,{messages:_,onSendMessage:z,loading:S,planStatus:j,limits:G,isLimitReached:Q})}),e.jsx(oe,{value:"premium",className:"flex-1 flex flex-col mt-0",children:e.jsx(as,{messages:_,onSendMessage:z,loading:S,isAdmin:x})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:e.jsxs(C.div,{initial:{opacity:0,y:30},animate:{opacity:1,y:0},transition:{duration:.8},className:"text-center max-w-md",children:[e.jsx("div",{className:"w-20 h-20 sardinian-gradient rounded-full flex items-center justify-center mx-auto mb-6",children:e.jsx(H,{className:"w-10 h-10 text-white"})}),e.jsx("h2",{className:"text-3xl font-bold text-white mb-4",children:"Benvenuto in SardAI Chat!"}),e.jsx("p",{className:"text-gray-300 mb-8",children:x?"Come amministratore hai accesso completo a tutte le funzionalità di chat.":"Seleziona una chat esistente dalla barra laterale o creane una nuova per iniziare a conversare con il tuo assistente sardo preferito."}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(b,{onClick:()=>E("free"),className:"w-full sardinian-gradient hover:opacity-90",children:[e.jsx(U,{className:"w-4 h-4 mr-2"}),"Inizia Chat Gratuita"]}),D&&e.jsxs(b,{onClick:()=>E("premium"),variant:"outline",className:`w-full ${x?"border-red-500/50 text-red-400 hover:bg-red-500/10":"border-yellow-500/50 text-yellow-400 hover:bg-yellow-500/10"}`,children:[x?e.jsx(O,{className:"w-4 h-4 mr-2"}):e.jsx(N,{className:"w-4 h-4 mr-2"}),"Inizia Chat ",x?"Admin":"Premium"]})]})]})})})]})]})]})}export{ds as default};
